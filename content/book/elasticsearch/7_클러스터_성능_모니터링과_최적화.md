# 클러스터 상태 확인

## 클러스터 상태
```
_cat/health 
_cat/health?v
_cat/health?format=json&pretty
```

green
- 모든 샤드가 정상적으로 동작하고 있는 상태

yellow
- 모든 프라이머리 샤드는 정상적으로 동작하고 있으나, 일부 혹은 모든 레플리카 샤드가 정상적으로 동작하고 있지 않은 상태

red
- 일부 혹은 모든 프라이머리 샤드/레플리카 샤드가 정상적으로 동작하고 있지 않은 상태
  - 저장되어야 할 문서가 저장되지 못하고 버려지는 상태

## 노드 상태
```
_cat/nodes
```
heap.percent (힙 메모리 사용률)
- JVM이 할당 받은 힙 메모리 내에서의 사용량
- 일정 수준 이상 커지면 old GC에 의해 힙 메모리 사용량이 다시 내려감
- 만약, 이 값이 낮아지지 않고 85% 이상을 유지한다면 메모리 부족이 발생할 가능성이 큼
  - 힙 메모리 부족 이유 확인 필요

memory.percent (메모리 사용률)
- 노드가 사용할 수 있는 전체 메모리에서 사용중인 메모리 사용률
- 이 값은 대부분 90% 이상의 높은 값을 나타냄
  - JVM에 할당된 힙 메모리 외의 영역은 OS에서 I/O 부하를 줄이기 위한 페이지 캐시로 사용하기 때문

ip
- node ip 주소

> 모니터링 시, cpu, load를 함께 확인 필요 
> - cpu개수에 따라 의미가 다를 수 있음

## 인덱스 상태
```
_cat/indices
_cat/indices?v&h=index,fielddata.memory_size
```
인덱스의 상태가 클러스터 상태를 결정
- 클러스터의 인덱스 중 한개라도 red가 있다면, 클러스터 상태도 red가 된다.
- 실제로 red가 아닌 인덱스에는 유실이 발생하지 않음


## 샤드 상태
```
_cat/shards
```
- STARTED: 정상적인 상태
- INITIALIZING: 샤드를 초기화 하는 상태. 최초 배치 시, 혹은 샤드에 문제가 발생하여 새롭게 배치할 때의 상태
- RELOCATING: 샤드가 현재의 노드에서 다른 노드로 이동하고 있는 상태. 새로운 데이터 노드가 추가되너가, 기존 데이터 노드에 문제가 생겨 새로운 노드에 배치되어야 할 때의 상태
- UNASSIGNED: 샤드가 어느 노드에도 배치되지 않은 상태. 해당 샤드가 배치된 노드에 문제가 생기거나 클러스터의 라우팅 정책에 의해 배치되지 않은 상태

unassigned 원인 출력
```
_cat/shards?h=index,shard,prirep,state,unassiged.reason
```
- INDEX_CREATED
- NODE_LEFT

## 성능 지표
```
_nodes/stats
_cluster/stats
```

- 색인 성능: 초당 몇개의 문서를 색인할 수 있는지, 그리고 각 문서를 색인하는데 소요되는 시간이 어느정도인지
- 검색 성능: 초당 몇개의 쿼리를 처리할 수 있는지, 그리고 각 쿼리를 처리하는 데 소요되는 시간이 어느 정도인지
- GC성능: GC가 너무 자주 오래 발생하면 STW같은 응답 불가 현상이 발생
- rejected: 클러스터가 처리할 수 없는 수준의 요청이 들어오면(큐가 가득 차면) 클러스터는 요청을 거절하게 되는데 그 횟수를 나타냄

### 색인, 검색 성능
```
_stats
```
- query: 검색 쿼리에 해당하는 문서가 있는 지 찾는 과정
- fetch: 찾은 문서들을 리스트의 형태로 만들어 정리하는 과정

### GC 성능
```
_nodes/stats
```







- 
